/* eslint-disable */
function MOVE(location,param){var childWin=window.open(location);window.addEventListener("message",(function(event){if("MOVE_READY_SIG"==event.data){var move_sys=window.__auth_system;move_sys.parent=window.location.href,childWin.postMessage(move_sys,"*")}}),!1),window.addEventListener("message",(function(event){console.log("Sent message to origin "+event.origin+" after receiving "+event.data+" signal")}))}function POST(system,post_data){var seed=Math.floor(1e9*Math.random())+1,signature=Sign(seed,system.pRSA),json_send=new Object;json_send.command="message",json_send.user=new Object,json_send.user.id=system.user,json_send.user.seed=seed,json_send.user.sign=btoa(signature),(md=forge.md.md5.create()).update(system.hash);var md,IV=md.digest().bytes();delete md,(md=forge.md.sha256.create()).update(system.hash);var to_return,cipher=forge.cipher.createCipher("AES-CBC",md.digest().bytes());cipher.start({iv:IV}),cipher.update(forge.util.createBuffer(JSON.stringify(post_data))),cipher.finish(),delete md,json_send.data=btoa(cipher.output.bytes()),console.log("Json Is: "+JSON.stringify(json_send));var send=btoa(JSON.stringify(json_send));return $.ajax({type:"POST",headers:{"Access-Control-Allow-Origin":"localhost:56083"},url:window.system.auth_server,data:send,success:function(response){var data=JSON.parse(atob(response));(md=forge.md.md5.create()).update(system.hash);var md,IV=md.digest().bytes();delete md,(md=forge.md.sha256.create()).update(system.hash);var cipher=forge.cipher.createDecipher("AES-CBC",md.digest().bytes());cipher.start({iv:IV}),cipher.update(forge.util.createBuffer(atob(data.data))),cipher.finish(),delete md,to_return=JSON.parse(cipher.output.bytes())},async:!1}),to_return}function handshake(system){var seed=Math.floor(1e9*Math.random())+1,signature=Sign(seed,system.pRSA),json_send=new Object;json_send.command="request_handshake",json_send.user=new Object,json_send.user.id=system.user,json_send.user.seed=seed,json_send.user.sign=btoa(signature),console.log("Json Is: "+JSON.stringify(json_send));var send=btoa(JSON.stringify(json_send));$.ajax({type:"POST",headers:{"Access-Control-Allow-Origin":"localhost:56083"},url:window.system.auth_server,data:send,success:function(response){var data=JSON.parse(atob(response));if(console.log("server response: "+JSON.stringify(data)),"connection_refused"==data.message)return MOVE(window.system.auth_page,!1),1;var decrypted=forge.pki.privateKeyFromPem(system.pRSA).decrypt(atob(data.hash),"RSAES-PKCS1-V1_5");system.hash=decrypted,console.log(decrypted)},async:!1})}class AuthSystem{INIT_FLAG=0;pRSA;hash;user;domain_location=window.location.href;protocol=window.location.protocol;domain=window.document.domain;port=window.location.port;parent=null;home="http://test.uniclient.localhost:8088";auth_server_domain="http://auth.localhost";auth_page=this.auth_server_domain+"/login.html";auth_domain="http://auth-serve.localhost";auth_server=this.auth_domain+"/php/src/external.php";REDIRECT_FLAG=0;_enc_prsa;_rsa;KEY_SET=0;setpRSA(T){this.pRSA=T}setHash(T){this.hash=T}setUser(T){this.user=T}setDomain(T){this.domain=T}setDomainLocation(T){this.domain_location=T}setParent(T){this.parent=T}setAuthServer(T){this.auth_server=T}set_enc_prsa(T){this._enc_prsa=T,this.KEY_SET=1}}export function onINIT(){if(console.log("SYS_INIT event fired. Initializing..."),Object.prototype.hasOwnProperty.call(window,"system")){console.log(window.__auth_system);var t_forge=document.createElement("script");if(t_forge.setAttribute("src",window.__auth_system.auth_server_domain+"/node_modules/node-forge/dist/forge.min.js"),document.body.appendChild(t_forge),"undefined"==typeof jQuery){var t_jquery=document.createElement("script");t_jquery.setAttribute("src",window.__auth_system.auth_server_domain+"/node_modules/jquery/dist/jquery.min.js"),document.body.appendChild(t_jquery)}}else{console.log("No system object found! Authentication required! Redirecting to auth page.");var t=new System;console.log(window.location.href),console.log(t.auth_page),window.location.href!=t.auth_page?window.open(t.auth_page):window.__auth_system=new System}}export default function init(){console.log("Loading System"),null!=window.opener&&(console.log("performing handshake..."),window.addEventListener("message",(function(event){console.log("system loaded"),window.__auth_system=event.data,window.__libauth__=!0;const myevent=new Event("SYS_INIT");window.dispatchEvent(myevent)}),!1),window.opener.postMessage("MOVE_READY_SIG","*"))}window.addEventListener("SYS_INIT",onINIT()),window.addEventListener("load",init());
